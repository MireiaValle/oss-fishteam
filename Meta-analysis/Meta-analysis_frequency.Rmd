---
title: 'Meta-Analysis: Red Snapper in the Gulf of Mexico'
author: "Group 3"
output:
  html_document:
    theme: yeti
    toc: FALSE
---
   
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r library setup, include=FALSE,results="hide"}
library(plotrix) #for quick s.e. calculations sometimes needed for data tidy step
library(meta) #nice package for most meta-statistics
library(DT)
library(tidyverse)
library(PRISMAstatement)
library(knitr)

```
<br><br>

#### Load lit search CSVs.
```{r Import Data}
WebOfSci1 <- read_csv("csvs/WebOfSci_GulfOfMexico_RedSnapper_Distribution.csv")
WebOfSci2 <- read_csv("csvs/WebOfSci_GulfOfMexico_RedSnapper_Dynamic.csv")
WebOfSci3 <- read_csv("csvs/WebOfSci_GulfOfMexico_RedSnapper_Habitat.csv")
Proquest1 <- read_csv("csvs/Proquest_GulfOfMexico_RedSnapper_Distribution.csv")
Proquest2 <- read_csv("csvs/Proquest_GulfOfMexico_RedSnapper_Dynamic.csv")
Proquest3 <- read_csv("csvs/Proquest_GulfOfMexico_RedSnapper_Habitat.csv")
GoogleScholar1 <-read_ris("csvs/GS_GulfOfMexico_RedSnapper_Distribution.RIS",50)
GoogleScholar2 <-read_ris("csvs/GS_GulfOfMexico_RedSnapper_Dynamic.RIS",50)
GoogleScholar3 <-read_ris("csvs/GS_GulfOfMexico_RedSnapper_Habitat.RIS",50)

# put all titles into one list
titleList <- rbind(WebOfSci1,WebOfSci2,WebOfSci3,Proquest1,Proquest2,Proquest3,
                   GoogleScholar1,GoogleScholar2,GoogleScholar3)

# make titles all lowercase for matching
titleListLower <- as.data.frame(str_to_lower(titleList$Title, locale = "en"))
colnames(titleListLower) <-c("Title")

# get subset of unique titles
uniqueTitles <- unique(titleListLower)
write.csv(uniqueTitles, file = "csvs/CombinedTitles.csv")

```


```{r Search Terms, warning=FALSE, message=FALSE}

searchTerms <- read_csv("search_terms.csv")
kable(searchTerms, align = 'cll')

```

<br><br>

#### Meta-analysis workflow

```{r Prisma, fig.keep='all',warning=FALSE, message=FALSE, fig.width=5, echo=FALSE}
prisma(found = 118,
       found_other = 11,
       no_dupes = 113, 
       screened = 113, 
       screen_exclusions = 87, 
       full_text = 26,
       full_text_exclusions = 14, 
       qualitative = 12, 
       quantitative = 12,
       width = 600, height = 600)
```


<br><br>

##### Reasons for paper eliminations

```{r Table of paper exclusions, echo=FALSE, message = FALSE}
paperReasons <- read_csv("paper_reasons.csv")
# datatable(paperReasons)
```



```{r Plot Exclusions,fig.keep='all',warning=FALSE, message=FALSE}
ggplot(paperReasons, aes(Reason, Papers)) + geom_bar(stat = "identity", fill="blue") + coord_flip() + theme_grey(base_size = 18)

```



```{r import metadata, echo=FALSE, warning=FALSE, message= FALSE}
data <- read_csv("meta-analysis_data.csv")
# datatable(data)

```

<br><br>

#### A range of drivers were investigated:

```{r plot by driver, results="hide"}

data.simple <- data %>% group_by(Driver) %>% count()
ggplot(na.omit(data.simple), aes(Driver, n)) + 
  geom_bar(stat = "identity", fill = "blue") + 
  coord_flip()+ theme_grey(base_size = 18)

```
<br><br>

Three main study types were represented:


```{r plot by study type}
data.simple <- data %>% group_by(StudyType) %>% count()
ggplot(na.omit(data.simple), aes(StudyType, n)) + 
  geom_bar(stat = "identity", fill = "blue") + 
  theme_grey(base_size = 18) + 
  coord_flip()

```
<br><br>
<br><br>
#### Age classes and definitions varied: 

```{r plot by age class, results="hide"}

data$Age_class[grep('juvenile',data$Age_class)] <- 'Juvenile'
data.simple <- data %>% group_by(Age_class) %>% count()

ggplot(na.omit(data.simple), aes(Age_class, n)) + 
  geom_bar(stat = "identity", fill = "blue") + 
  theme_grey(base_size = 18) +
  coord_flip()

```
<br><br>

#### Effect sizes

```{r Estimate effect size by driver, results="hide", echo = FALSE}
treedata <- data %>% group_by(Driver) %>% summarise(mean.EffectSize_d = mean(EffectSize_d),
                                                    error = std.error(EffectSize_d))
```

```{r, Forest plot}
m <- metagen(mean.EffectSize_d, error, studlab = Driver, data = treedata) #fit generic meta-analysis to an object

#viz (draw a standard forest plot or metaregression plot)
forest(m,leftcols = "Driver",rightcols = c("effect", "ci"), fontsize=12) #grid-based graphics so a bit of work to resize
```

![](./Final_heat_map.png) 

[Next Topic](https://nceas.github.io/oss-fishteam/R_code/Wrangle_Markdown.html)
